---
title: "Passport"
categories:
    - Nodejs
tags:
    - Nodejs & Security
date: 2023-08-18
toc: true
---

### Passport 

_참고: <http://www.passport.org>_


- Node.js에서의 미들웨어로, 새로운 사용자의 애플리케이션상에서의 인증활동을 수행하고 패스워드를 해싱

- Passport를 이용하면 제삼자 로그인 서비스(google,naver 등)를 이용할 수 있음(물론, 기본 local login도 가능)


* #### How to install passport 

```
npm install passport -S
npm install passport-local-sequelize 
//if you use other DB ORM, look up there is npm for it in npm website
```

### Passport process

* ### Settting to start 

- passport를 사용하기 위해서, passport를 초기화시켜주어야 함

- passport가 express내에서 세션을 사용할 수 있도록 설정


```js
const passport = require("passport");
// ...
app.use(passport.initialize());
app.use(passport.session());
```

**위에 코드를 입력하기 전에 앞에 cookie parser와 session이 설정되어 있는지를 확인해야함**

![image](https://github.com/dareunk/dareunk.github.io/assets/83913407/da7f1ab4-634e-43f7-85bd-c79abe140e2f)


* #### check the success of authenticate 

```js
const LocalStrategy = require("passport-local").Strategy;
passport.use(new LocalStrategy({
    usernameField: "email",
    passwordField: "password",
    session: true 
    passReqToCallback: false,
}, async function(email, password, done){
    //console.log(email, password);
    try{
        const user = await User.findOne({
                    where: {email: email}
        });
        if(user){
            if(password !== user.password){
                return done(null,false,{message: "password's wrong"});
            }
            else return done(null,user); // return user
        }else{
            return done(null,false,{message:"the user does not exist"});
        }
    }catch(err){
        return done(err);
    }
}));
```

* #### Serialize and Deserialize 

- Serialize: 사용자 데이터를 저장 (직렬화)

- Deserialize: 클라이언트로 부터 마지막에 로그인한 사용자를 찾기 위해, 사용자 데이터를 복구해 사용자 정보 확인

- authenticate성공 시 serialize 수행, 마찬가지로 serialize가 실행되야 deserialize 실행.

```js
//If authenticate successes through above proecss, passport returns user(if not, it returns false)
//After the success, execute serializeUser(if not, can't execute serializeUser) 

passport.serializeUser(function(user,done){
done(null,user.id); // return user.id to minimize the size, not user;
});


// need to the same variable returned from serializing in deserialized process
passport.deserializeUser(async function(id,done){
    const user = await User.findOne({
        where:{id:id}
    });
    done(null,user);
});
```

**주의: serialize로 반환하는 변수가 deserialize의 변수로 넘어옴**

![image](https://github.com/dareunk/dareunk.github.io/assets/83913407/885ffaad-fae7-4b07-b13a-5d361d878d7f)

